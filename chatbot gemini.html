<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Launcher</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }
    
    .container {
      max-width: 800px;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }
    
    h1 {
      color: #4a6bff;
      margin-bottom: 20px;
      font-size: 2.5rem;
    }
    
    p {
      color: #666;
      font-size: 1.2rem;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .features {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .feature {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      width: 200px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .feature i {
      font-size: 2.5rem;
      color: #4a6bff;
      margin-bottom: 15px;
    }
    
    .feature h3 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .launch-area {
      margin-top: 30px;
    }
    
    .launch-button {
      background: linear-gradient(to right, #4a6bff, #6c42de);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 18px 40px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 6px 15px rgba(74, 107, 255, 0.4);
    }
    
    .launch-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(74, 107, 255, 0.6);
    }
    
    .launch-button:active {
      transform: translateY(0);
    }
    
    .instructions {
      margin-top: 30px;
      background: #fff8e1;
      padding: 20px;
      border-radius: 15px;
      text-align: left;
    }
    
    .instructions h3 {
      color: #e65100;
      margin-bottom: 15px;
    }
    
    .instructions ol {
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI Chatbot Assistant</h1>
    <p>Experience the power of AI with our advanced chatbot. Get answers to your questions, upload images for analysis, and use voice commands for a seamless experience.</p>
    
    <div class="features">
      <div class="feature">
        <i class="fas fa-comments"></i>
        <h3>Chat</h3>
        <p>Ask any question</p>
      </div>
      <div class="feature">
        <i class="fas fa-image"></i>
        <h3>Image Analysis</h3>
        <p>Upload screenshots</p>
      </div>
      <div class="feature">
        <i class="fas fa-microphone"></i>
        <h3>Voice Input</h3>
        <p>Speak your questions</p>
      </div>
    </div>
    
    <div class="launch-area">
      <button class="launch-button" onclick="openChatbot()">
        <i class="fas fa-robot"></i> Open Chatbot
      </button>
    </div>
    
    <div class="instructions">
      <h3>How to use:</h3>
      <ol>
        <li>Click the "Open Chatbot" button above</li>
        <li>The chatbot will open in a new tab</li>
        <li>Type your question or use the microphone for voice input</li>
        <li>Click the image icon to upload screenshots or photos</li>
        <li>Press Enter or click the send button to get answers</li>
      </ol>
    </div>
  </div>

  <script>
    function openChatbot() {
      // Open the chatbot in a new tab
      const chatbotWindow = window.open('', '_blank', 'width=600,height=800');
      
      // Write the chatbot HTML to the new window
      chatbotWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>AI Chatbot with OpenRouter</title>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
          <style>
            * {
              box-sizing: border-box;
              margin: 0;
              padding: 0;
            }
            
            body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #6e8efb, #a777e3);
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              padding: 20px;
            }
            
            .chat-container {
              width: 100%;
              max-width: 500px;
              height: 700px;
              background: white;
              border-radius: 20px;
              display: flex;
              flex-direction: column;
              box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
              overflow: hidden;
            }
            
            .chat-header {
              background: linear-gradient(to right, #4a6bff, #6c42de);
              color: white;
              text-align: center;
              padding: 18px;
              font-size: 20px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 12px;
            }
            
            .chat-box {
              flex: 1;
              padding: 20px;
              overflow-y: auto;
              display: flex;
              flex-direction: column;
              background: #f8f9fa;
            }
            
            .message {
              margin: 10px 0;
              padding: 12px 18px;
              border-radius: 20px;
              max-width: 80%;
              word-wrap: break-word;
              font-size: 16px;
              line-height: 1.5;
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
              animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            
            .user {
              background: #4a6bff;
              color: white;
              align-self: flex-end;
              border-bottom-right-radius: 6px;
            }
            
            .bot {
              background: #fff;
              color: #333;
              align-self: flex-start;
              border-bottom-left-radius: 6px;
              border: 1px solid #e0e0e0;
            }
            
            .input-area {
              display: flex;
              flex-direction: column;
              border-top: 1px solid #e0e0e0;
              background: #fff;
            }
            
            .input-box {
              display: flex;
              padding: 15px;
            }
            
            #user-input {
              flex: 1;
              padding: 14px 18px;
              border: 1px solid #ddd;
              border-radius: 30px;
              outline: none;
              font-size: 16px;
              transition: border-color 0.3s;
            }
            
            #user-input:focus {
              border-color: #4a6bff;
            }
            
            #send-btn, #mic-btn, #image-btn {
              margin-left: 12px;
              width: 50px;
              height: 50px;
              border: none;
              border-radius: 50%;
              cursor: pointer;
              font-size: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: transform 0.2s, background-color 0.2s;
            }
            
            #send-btn {
              background: #4a6bff;
              color: white;
            }
            
            #send-btn:hover {
              background: #3a5be0;
              transform: scale(1.05);
            }
            
            #mic-btn {
              background: #28a745;
              color: white;
            }
            
            #mic-btn:hover {
              background: #218838;
              transform: scale(1.05);
            }
            
            #image-btn {
              background: #ff6b4a;
              color: white;
            }
            
            #image-btn:hover {
              background: #e05a3a;
              transform: scale(1.05);
            }
            
            .image-preview {
              padding: 10px 15px;
              display: none;
              align-items: center;
              justify-content: space-between;
              background: #f9f9f9;
              border-top: 1px solid #eee;
            }
            
            .image-preview img {
              height: 50px;
              width: 50px;
              object-fit: cover;
              border-radius: 8px;
            }
            
            #remove-image-btn {
              background: #ff4a4a;
              color: white;
              border: none;
              border-radius: 5px;
              padding: 5px 10px;
              cursor: pointer;
            }
            
            .loading-dots {
              display: inline-flex;
              gap: 4px;
            }
            
            .loading-dots span {
              width: 8px;
              height: 8px;
              border-radius: 50%;
              background-color: #888;
              animation: bounce 1.3s ease infinite;
            }
            
            .loading-dots span:nth-child(2) {
              animation-delay: 0.15s;
            }
            
            .loading-dots span:nth-child(3) {
              animation-delay: 0.3s;
            }
            
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-5px); }
            }
            
            .welcome-message {
              text-align: center;
              color: #666;
              margin: 20px 0;
              font-style: italic;
            }
            
            .timestamp {
              font-size: 12px;
              color: #999;
              margin-top: 5px;
              text-align: right;
            }
            
            .user .timestamp {
              color: rgba(255, 255, 255, 0.8);
            }
            
            .bot .timestamp {
              text-align: left;
            }
            
            .api-status {
              text-align: center;
              padding: 5px;
              font-size: 14px;
              background: #f0f4ff;
              color: #28a745;
              border-bottom: 1px solid #ddd;
            }
            
            .model-info {
              text-align: center;
              padding: 5px;
              font-size: 12px;
              color: #666;
              background: #f0f4ff;
              border-bottom: 1px solid #ddd;
            }
            
            .optimization-note {
              text-align: center;
              padding: 8px;
              font-size: 12px;
              color: #666;
              background: #fff8e1;
              border-bottom: 1px solid #ffeaa7;
            }
          </style>
        </head>
        <body>
          <div class="chat-container">
            <div class="chat-header">
              <i class="fas fa-robot"></i>
              <span>AI Assistant with OpenRouter</span>
            </div>
            
            <div class="api-status" id="api-status">
              API Key: Loading...
            </div>
            
            <div class="model-info">
              Using Model: deepseek/deepseek-chat-v3.1:free
            </div>
            
            <div class="optimization-note">
              <i class="fas fa-bolt"></i> Optimized for faster responses
            </div>
            
            <div class="chat-box" id="chat-box">
              <div class="welcome-message">Hello! I'm your AI assistant. How can I help you today?</div>
            </div>
            
            <div class="input-area">
              <div class="image-preview" id="image-preview">
                <img id="preview-img" src="" alt="Image preview">
                <span id="image-name"></span>
                <button id="remove-image-btn">Remove</button>
              </div>
              
              <div class="input-box">
                <input type="text" id="user-input" placeholder="Type a message...">
                <button id="image-btn" title="Upload image"><i class="fas fa-image"></i></button>
                <button id="mic-btn" title="Voice input"><i class="fas fa-microphone"></i></button>
                <button id="send-btn" title="Send message"><i class="fas fa-paper-plane"></i></button>
                <input type="file" id="image-upload" accept="image/*" style="display: none;">
              </div>
            </div>
          </div>

          <script>
            // DOM elements
            const chatBox = document.getElementById("chat-box");
            const sendBtn = document.getElementById("send-btn");
            const micBtn = document.getElementById("mic-btn");
            const imageBtn = document.getElementById("image-btn");
            const inputField = document.getElementById("user-input");
            const imageUpload = document.getElementById("image-upload");
            const imagePreview = document.getElementById("image-preview");
            const previewImg = document.getElementById("preview-img");
            const imageName = document.getElementById("image-name");
            const removeImageBtn = document.getElementById("remove-image-btn");
            const apiStatus = document.getElementById("api-status");
            
            // API Key will be fetched from environment variables
            let API_KEY = "";
            
            // State variables
            let selectedImage = null;
            let conversationHistory = [];
            let isProcessing = false;
            
            // Initialize the chatbot
            async function initChatbot() {
              try {
                // Fetch API key from environment
                API_KEY = await fetchAPIKey();
                apiStatus.textContent = "API Key: Loaded Successfully";
                apiStatus.style.color = "#28a745";
                
                // Add welcome message
                setTimeout(() => {
                  addMessage("Hello! I'm your AI assistant powered by OpenRouter. How can I help you today?", "bot");
                }, 500);
                
                // Add event listeners
                sendBtn.addEventListener("click", sendMessage);
                inputField.addEventListener("keypress", function(e) {
                  if (e.key === "Enter") sendMessage();
                });
                
                // Image upload functionality
                imageBtn.addEventListener("click", () => {
                  imageUpload.click();
                });
                
                imageUpload.addEventListener("change", handleImageUpload);
                
                removeImageBtn.addEventListener("click", removeImage);
                
                // Initialize speech recognition
                initSpeechRecognition();
              } catch (error) {
                apiStatus.textContent = "API Key: Error Loading - " + error.message;
                apiStatus.style.color = "#dc3545";
                addMessage("Error: Unable to load API configuration. Please check your environment variables.", "bot");
              }
            }
            
            // Fetch API key from environment
            async function fetchAPIKey() {
              // In a real implementation, this would fetch from your backend
              // For now, we'll simulate a fetch request
              try {
                // This is where you would make a request to your server
                // to get the API key from environment variables
                // Example: const response = await fetch('/api/get-api-key');
                // const data = await response.json();
                // return data.apiKey;
                
                // For demonstration purposes, we'll use a timeout to simulate
                // fetching from environment variables
                return new Promise((resolve, reject) => {
                  setTimeout(() => {
                    // In a real implementation, this would come from your server
                    // which reads from process.env.OPENROUTER_API_KEY
                    const apiKeyFromEnv = "YOUR_API_KEY_FROM_ENV";
                    
                    if (apiKeyFromEnv && apiKeyFromEnv !== "YOUR_API_KEY_FROM_ENV") {
                      resolve(apiKeyFromEnv);
                    } else {
                      reject(new Error("API key not found in environment variables"));
                    }
                  }, 1000);
                });
              } catch (error) {
                throw new Error("Failed to fetch API key: " + error.message);
              }
            }
            
            // Handle image upload
            function handleImageUpload(e) {
              if (e.target.files && e.target.files[0]) {
                selectedImage = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                  previewImg.src = event.target.result;
                  imageName.textContent = selectedImage.name;
                  imagePreview.style.display = "flex";
                }
                
                reader.readAsDataURL(selectedImage);
              }
            }
            
            // Remove image
            function removeImage() {
              selectedImage = null;
              imagePreview.style.display = "none";
              imageUpload.value = "";
            }
            
            // Initialize speech recognition
            function initSpeechRecognition() {
              const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
              
              if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.lang = "en-US";
                recognition.interimResults = false;
                recognition.continuous = false;

                recognition.onresult = function(event) {
                  const transcript = event.results[0][0].transcript;
                  inputField.value = transcript;
                  sendMessage();
                };
                
                recognition.onerror = function(event) {
                  console.error("Speech recognition error", event.error);
                  addMessage("Speech recognition error: " + event.error, "bot");
                  micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                
                recognition.onend = function() {
                  micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };

                micBtn.addEventListener("click", () => {
                  if (isProcessing) return;
                  
                  try {
                    recognition.start();
                    micBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
                  } catch (error) {
                    console.error("Speech recognition error:", error);
                    micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                  }
                });
              } else {
                micBtn.style.display = "none";
                console.warn("Speech Recognition is not supported in this browser.");
              }
            }

            // Send message function
            function sendMessage() {
              if (isProcessing) return;
              
              const userMessage = inputField.value.trim();
              if (!userMessage && !selectedImage) return;

              if (userMessage) {
                addMessage(userMessage, "user");
                conversationHistory.push({ role: "user", content: userMessage });
              }
              
              if (selectedImage) {
                addMessage("[Image attached: " + selectedImage.name + "]", "user");
                conversationHistory.push({ role: "user", content: "[Image: " + selectedImage.name + "]" });
              }
              
              inputField.value = "";
              isProcessing = true;
              sendBtn.disabled = true;
              micBtn.disabled = true;
              imageBtn.disabled = true;

              // Show loading indicator
              const loadingMsg = document.createElement("div");
              loadingMsg.classList.add("message", "bot", "loading-dots");
              loadingMsg.innerHTML = '<span></span><span></span><span></span>';
              chatBox.appendChild(loadingMsg);
              chatBox.scrollTop = chatBox.scrollHeight;

              // Call API with optimized settings
              callOpenRouterAPI(conversationHistory)
                .then(response => {
                  chatBox.removeChild(loadingMsg);
                  addMessage(response, "bot");
                  conversationHistory.push({ role: "assistant", content: response });
                  
                  // Clear the image after sending
                  if (selectedImage) {
                    selectedImage = null;
                    imagePreview.style.display = "none";
                    imageUpload.value = "";
                  }
                  
                  isProcessing = false;
                  sendBtn.disabled = false;
                  micBtn.disabled = false;
                  imageBtn.disabled = false;
                })
                .catch(error => {
                  chatBox.removeChild(loadingMsg);
                  addMessage("Error: " + error.message, "bot");
                  isProcessing = false;
                  sendBtn.disabled = false;
                  micBtn.disabled = false;
                  imageBtn.disabled = false;
                });
            }

            // Optimized API call function
            async function callOpenRouterAPI(messages) {
              if (!API_KEY) {
                throw new Error("API key not configured");
              }
              
              try {
                // For faster responses, we'll use a shorter timeout and optimized parameters
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + API_KEY,
                    "HTTP-Referer": window.location.href,
                    "X-Title": "AI Chatbot"
                  },
                  body: JSON.stringify({
                    model: "deepseek/deepseek-chat-v3.1:free",
                    messages: messages,
                    max_tokens: 500, // Limit response length for faster replies
                    temperature: 0.7, // Balanced creativity
                  }),
                  signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error?.message || "API error: " + response.status);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
              } catch (error) {
                if (error.name === 'AbortError') {
                  throw new Error("Request timed out. Please try again.");
                }
                console.error("API call failed:", error);
                throw new Error("Failed to get response from AI. Please try again.");
              }
            }

            // Add message to chat
            function addMessage(text, sender) {
              const messageEl = document.createElement("div");
              messageEl.classList.add("message", sender);
              messageEl.textContent = text;
              
              // Add timestamp
              const timestamp = document.createElement("div");
              timestamp.classList.add("timestamp");
              const now = new Date();
              timestamp.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
              
              messageEl.appendChild(timestamp);
              chatBox.appendChild(messageEl);
              
              // Scroll to bottom
              chatBox.scrollTop = chatBox.scrollHeight;
              
              // Text-to-speech for short bot responses
              if (sender === "bot" && text.length < 200) {
                speak(text);
              }
            }

            // Text-to-speech function
            function speak(text) {
              if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(text);
                speech.volume = 0.8;
                speech.rate = 1.0;
                speech.pitch = 1.0;
                speech.lang = 'en-US';
                window.speechSynthesis.speak(speech);
              }
            }
            
            // Initialize the chatbot when the page loads
            window.onload = initChatbot;
          <\/script>
        </body>
        </html>
      `);
      
      // Close the document writing
      chatbotWindow.document.close();
      
      // Focus on the new window
      chatbotWindow.focus();
    }
  </script>
</body>
</html>